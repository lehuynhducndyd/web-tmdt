<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>
        <%= product.name %> - Chi tiết sản phẩm
    </title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Raleway:wght@600;800&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <link href="/client/lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">

    <link href="/client/css/bootstrap.min.css" rel="stylesheet">

    <link href="/client/css/style.css" rel="stylesheet">

    <style>
        #shop-detail-page {
            background-color: #f8f9fa;
        }

        /* KHẮC PHỤC BỐ CỤC CỘT QUAN TRỌNG START */
        /* Đảm bảo hàng chính là Flexbox container */
        #shop-detail-page .row.g-4.mb-5 {
            display: flex;
            flex-wrap: wrap;
            /* Cho phép các cột xuống dòng nếu cần */
            align-items: flex-start;
            /* Căn chỉnh các cột lên trên cùng */
            margin: 0 -15px;
            /* Sửa lỗi margin âm của row */
        }

        /* Cột ảnh (col-xl-4) */
        #shop-detail-page .col-xl-4 {
            flex: 0 0 33.333333%;
            max-width: 33.333333%;
            padding: 15px;
        }

        /* Cột thông tin sản phẩm (col-xl-5) */
        #shop-detail-page .col-xl-5 {
            flex: 0 0 41.666667%;
            max-width: 41.666667%;
            padding: 15px 20px;
        }

        /* Cột thông số kỹ thuật (col-xl-3) */
        #shop-detail-page .col-xl-3 {
            flex: 0 0 25%;
            max-width: 25%;
            padding: 25px;
            background: #ffffff;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            font-size: 0.9rem;
        }

        /* KHẮC PHỤC BỐ CỤC CỘT QUAN TRỌNG END */

        /* Cải thiện hiển thị văn bản tràn */
        #shop-detail-page h1,
        #shop-detail-page h5 {
            white-space: normal;
            /* Cho phép tiêu đề xuống dòng */
            word-break: break-word;
        }

        /* Cải thiện các thành phần nhỏ */

        #shop-detail-page h1 {
            font-size: 2.5rem;
            /* Giảm nhẹ kích thước */
            font-weight: 800 !important;
            color: #333;
            margin-top: 0;
        }

        #shop-detail-page #variant-price-display {
            font-size: 1.8rem;
            color: #d63384 !important;
            margin-bottom: 20px !important;
            padding-bottom: 5px;
            border-bottom: 2px solid #eee;
        }

        #shop-detail-page .variant-selection {
            font-size: 0.9rem;
            padding: 10px 18px;
            transition: all 0.3s ease;
            font-weight: 600;
            border-color: #ced4da !important;
        }

        #shop-detail-page .variant-selection:hover,
        #shop-detail-page .btn-primary,
        #shop-detail-page .variant-selection.btn-primary {
            background-color: #007bff !important;
            border-color: #007bff !important;
            color: white !important;
        }

        #shop-detail-page .d-flex.mb-4 small {
            /* Sửa lỗi tràn dòng thương hiệu/danh mục */
            line-height: 1.4;
        }

        #shop-detail-page .list-unstyled li {
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
        }

        #shop-detail-page .list-unstyled li i {
            color: #007bff !important;
        }

        #shop-detail-page .rounded {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #shop-detail-page .container-fluid.py-5.mt-5 {
            margin-top: 5rem !important;
            padding-top: 4rem !important;
        }

        /* === REVIEW SECTION STYLES === */
        .review-section {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .review-form .star-rating {
            display: flex;
            flex-direction: row-reverse;
            justify-content: flex-end;
            gap: 5px;
            margin-bottom: 15px;
        }

        .review-form .star-rating input[type="radio"] {
            display: none;
        }

        .review-form .star-rating label {
            font-size: 2rem;
            color: #ddd;
            cursor: pointer;
            transition: color 0.2s;
        }

        .review-form .star-rating input[type="radio"]:checked~label,
        .review-form .star-rating label:hover,
        .review-form .star-rating label:hover~label {
            color: #ffc107;
        }

        .review-list .review-item {
            border-bottom: 1px solid #eee;
            padding: 20px 0;
        }

        .review-list .review-item:last-child {
            border-bottom: none;
        }

        .review-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .review-header .avatar {
            width: 40px;
            height: 40px;
            background-color: var(--bs-primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .review-stars {
            color: #ffc107;
        }
    </style>
</head>

<body id="shop-detail-page">
    <%- include('../layout/navbar'); -%>

        <div class="container-fluid ">
            <div class="container py-5">
                <div class="row g-4">
                    <div class="col-lg-8 col-xl-4">
                        <div class="image-gallery">
                            <div class="main-image position-relative overflow-hidden rounded">
                                <% const mainImageUrl=(product.thumbnail && product.thumbnail.data) ?
                                    `data:${product.thumbnail.contentType};base64,${product.thumbnail.data.toString('base64')}`
                                    : '/admin/img/default-image.png' ; %>
                                    <img src="<%= mainImageUrl %>" class="img-fluid w-100" alt="<%= product.name %>"
                                        id="main-product-image"
                                        style="height: 250px; object-fit: contain; cursor: pointer;"
                                        data-bs-toggle="modal" data-bs-target="#imageModal"
                                        data-image-src="<%= mainImageUrl %>">
                            </div>
                            <div class="image-gallery-thumbnails">
                                <!-- Main Thumbnail -->
                                <div class="thumbnail-item active">
                                    <img src="<%= mainImageUrl %>" alt="Thumbnail 0" data-bs-toggle="modal"
                                        data-bs-target="#imageModal" data-image-src="<%= mainImageUrl %>">
                                </div>
                                <!-- Additional Images -->
                                <% if (product.images && product.images.length> 0) { %>
                                    <% product.images.forEach(function(image, index) { %>
                                        <% const
                                            imageUrl=`data:${image.contentType};base64,${image.data.toString('base64')}`;
                                            %>
                                            <div class="thumbnail-item">
                                                <!-- Visible thumbnail -->
                                                <img src="<%= imageUrl %>" alt="Thumbnail <%= index + 1 %>"
                                                    data-bs-toggle="modal" data-bs-target="#imageModal"
                                                    data-image-src="<%= imageUrl %>">
                                            </div>
                                            <% }); %>
                                                <% } %>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-8 col-xl-5">
                        <h1 class="fw-bold mb-3">
                            <%= product.name %>
                        </h1>
                        <div class="d-flex mb-4">
                            <small class="me-3"><i class="fas fa-box text-warning me-2"></i>Thương hiệu: <strong>
                                    <%= product.brand ? product.brand.name : 'N/A' %>
                                </strong></small>
                            <small><i class="fas fa-list-alt text-warning me-2"></i>Danh mục: <strong>
                                    <%= product.category ? product.category.name : 'N/A' %>
                                </strong></small>
                        </div>

                        <div id="price-container" class="d-flex align-items-baseline mb-4">
                            <% if (product.price> 0) { %>
                                <% if (product.hasDiscount) { %>
                                    <!-- Giá sau khi giảm -->
                                    <h4 class="fw-bold text-danger me-3" id="variant-price-display">
                                        <%= new Intl.NumberFormat('vi-VN', { style: 'currency' , currency: 'VND'
                                            }).format(product.price) %>
                                    </h4>
                                    <!-- Giá gốc (bị gạch) -->
                                    <h5 class="fw-normal text-muted text-decoration-line-through"
                                        id="variant-original-price-display">
                                        <%= new Intl.NumberFormat('vi-VN', { style: 'currency' , currency: 'VND'
                                            }).format(product.originalPrice) %>
                                    </h5>
                                    <% } else { %>
                                        <h4 class="fw-bold text-primary" id="variant-price-display">
                                            <%= new Intl.NumberFormat('vi-VN', { style: 'currency' , currency: 'VND'
                                                }).format(product.price) %>
                                        </h4>
                                        <% } %>
                                            <% } else { %>
                                                <h4 class="fw-bold text-primary" id="variant-price-display">Giá: Liên hệ
                                                </h4>
                                                <% } %>
                        </div>

                        <h5 class="fw-bold mt-4">Chọn Phiên bản:</h5>
                        <div class="d-flex flex-wrap mb-4">
                            <% variants.forEach(function(variant){ %>
                                <button type="button"
                                    class="btn btn-outline-secondary rounded-pill me-2 mb-2 variant-selection"
                                    data-variant-id="<%= variant._id %>" data-color="<%= variant.color %>"
                                    data-price="<%= variant.price %>" data-stock="<%= variant.stock %>" <% if (isDevice)
                                    { %>
                                    data-discount="<%= variant.discount || 0 %>"
                                        data-original-price="<%= variant.price %>"
                                            data-model-url="<%= variant.model3d %>"
                                                data-ram="<%= variant.ram %>"
                                                    data-storage="<%= variant.storage %>"
                                                        <% } %>>
                                                            <% if (isDevice) { %>
                                                                <%= variant.color %> | <%= variant.ram %>/<%=
                                                                            variant.storage %>
                                                                            <% } else { %>
                                                                                <%= variant.color %>
                                                                                    <% } %></button>
                                <% }); %>
                        </div>
                        <div class="mb-4">
                            <p class="mb-0">Số lượng còn lại: <strong id="variant-stock-display">--</strong></p>
                        </div>
                        <form action="/add-product-to-cart" method="POST">
                            <input type="hidden" name="productId" value="<%= product._id %>">
                            <input type="hidden" name="productType" value="<%= isDevice ? 'Device' : 'Accessory' %>">
                            <input type="hidden" name="variantId" id="selectedVariantId" value="">
                            <input type="number" name="quantity" id="" value="1" hidden>
                            <div class="d-flex align-items-center">
                                <!-- <div class="input-group quantity me-4" style="width: 120px;">
                                    <div class="input-group-btn">
                                        <button class="btn-sm btn-minus rounded-circle bg-light border" type="button">
                                            <i class="fa fa-minus"></i>
                                        </button>
                                    </div>
                                    <input type="text" class="form-control form-control-sm text-center border-0"
                                        value="1" min="1" max="<%= variants.length > 0 ? variants[0].stock : 1 %>"
                                        id="quantityInput" name="quantity">
                                    <div class="input-group-btn">
                                        <button class="btn-sm btn-plus rounded-circle bg-light border" type="button">
                                            <i class="fa fa-plus"></i>
                                        </button>
                                    </div>
                                </div> -->
                                <button type="button" id="view-3d-btn"
                                    class="btn btn-warning rounded-pill px-4 py-2 me-3" data-bs-toggle="modal"
                                    data-bs-target="#model3dModal" style="display: none;">
                                    <i class="fas fa-cube me-2"></i> Xem 3D
                                </button>
                                <button type="submit" id="addToCartBtn"
                                    class="btn border border-secondary rounded-pill px-4 py-2 text-primary">
                                    <i class="fa fa-shopping-bag me-2 text-primary"></i> Thêm vào giỏ
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="col-lg-12 col-xl-3">
                        <h5 class="fw-bold mb-4">Mô tả sản phẩm</h5>
                        <p>
                            <%= product.description %>
                        </p>

                        <% if (isDevice) { %>
                            <h5 class="fw-bold mt-4">Thông số kỹ thuật chính:</h5>
                            <ul class="list-unstyled">
                                <% if (variants && variants.length> 0) { %>
                                    <li><i class="fas fa-check text-success me-2"></i>RAM: <strong id="spec-ram">
                                            <%= variants[0].ram %>
                                        </strong>
                                    </li>
                                    <li><i class="fas fa-check text-success me-2"></i>Bộ nhớ: <strong id="spec-storage">
                                            <%= variants[0].storage %>
                                        </strong></li>
                                    <% } %>

                                        <% if (product.specs) { %>
                                            <li><i class="fas fa-check text-success me-2"></i>Màn hình: <strong>
                                                    <%= product.specs.screen || 'N/A' %>
                                                </strong></li>
                                            <li><i class="fas fa-check text-success me-2"></i>CPU: <strong>
                                                    <%= product.specs.cpu || 'N/A' %>
                                                </strong></li>
                                            <li><i class="fas fa-check text-success me-2"></i>Pin: <strong>
                                                    <%= product.specs.battery || 'N/A' %>
                                                </strong></li>
                                            <li><i class="fas fa-check text-success me-2"></i>Camera: <strong>
                                                    <%= product.specs.camera || 'N/A' %>
                                                </strong></li>
                                            <li><i class="fas fa-check text-success me-2"></i>Hệ điều hành: <strong>
                                                    <%= product.specs.os || 'N/A' %>
                                                </strong></li>
                                            <% } %>
                            </ul>
                            <% } %>
                    </div>
                </div>

                <div class="container-fluid fruite">
                    <div class="container py-5 fruite">
                        <h1 class="fw-bold mb-4">Sản phẩm liên quan</h1>
                        <div class="row g-4">
                            <% relatedProducts.forEach(function(relatedProduct){ %>
                                <div class="col-md-6 col-lg-4 col-xl-3">
                                    <a href="/shop-detail/<%= relatedProduct._id %>" class="product-card-link">
                                        <div
                                            class="rounded position-relative fruite-item border border-light-subtle rounded-bottom">
                                            <div class="product-image-container">
                                                <% if (relatedProduct.thumbnail && relatedProduct.thumbnail.data) { %>
                                                    <img src="data:<%= relatedProduct.thumbnail.contentType %>;base64,<%= relatedProduct.thumbnail.data.toString('base64') %>"
                                                        class="img-fluid" alt="<%= relatedProduct.name %>"
                                                        style="max-height: 100%; max-width: 100%; object-fit: contain;">
                                                    <% } else { %>
                                                        <img src="/admin/img/default-image.png" class="img-fluid"
                                                            alt="No Image"
                                                            style="max-height: 100%; max-width: 100%; object-fit: contain;">
                                                        <% } %>
                                            </div>
                                            <div class="p-4">
                                                <h4>
                                                    <p style="font-size: 15px;">
                                                        <%= relatedProduct.name %>
                                                    </p>
                                                </h4>
                                                <div class="d-flex flex-lg-wrap">
                                                    <p class="text-dark fs-5 fw-bold mb-3"
                                                        style="font-size: 15px; text-align: center; width: 100%;">
                                                        <% if (relatedProduct.price> 0) { %>
                                                            <%= new Intl.NumberFormat('vi-VN', { style: 'currency' ,
                                                                currency: 'VND' }).format(relatedProduct.price) %>
                                                                <% } else { %>
                                                                    Liên hệ
                                                                    <% } %>
                                                    </p>
                                                    <a href="/shop-detail/<%= relatedProduct._id %>"
                                                        class="btn border border-secondary rounded-pill px-3 text-primary mx-auto">
                                                        <i class="fa fa-shopping-bag me-2 text-primary"></i> Xem chi
                                                        tiết
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                                <% }); %>
                        </div>
                    </div>
                </div>

                <!-- ========================================================== -->
                <!-- START: REVIEW SECTION - PHẦN ĐÁNH GIÁ -->
                <!-- ========================================================== -->
                <div class="row g-4 mt-4">
                    <div class="col-lg-12">
                        <div class="review-section">
                            <h2 class="fw-bold mb-4">Đánh giá sản phẩm</h2>

                            <!-- Form để lại đánh giá (chỉ hiện khi đã đăng nhập) -->
                            <% if (user) { %>
                                <div class="review-form mb-5">
                                    <h4 class="mb-3">Để lại đánh giá của bạn</h4>
                                    <form action="/shop-detail/<%= product._id %>/reviews" method="POST">
                                        <div class="mb-3">
                                            <label class="form-label">Xếp hạng:</label>
                                            <div class="star-rating">
                                                <input type="radio" id="5-stars" name="rating" value="5" required
                                                    checked /><label for="5-stars" class="fas fa-star"></label>
                                                <input type="radio" id="4-stars" name="rating" value="4" /><label
                                                    for="4-stars" class="fas fa-star"></label>
                                                <input type="radio" id="3-stars" name="rating" value="3" /><label
                                                    for="3-stars" class="fas fa-star"></label>
                                                <input type="radio" id="2-stars" name="rating" value="2" /><label
                                                    for="2-stars" class="fas fa-star"></label>
                                                <input type="radio" id="1-star" name="rating" value="1" /><label
                                                    for="1-star" class="fas fa-star"></label>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="comment" class="form-label">Bình luận của bạn:</label>
                                            <textarea class="form-control" id="comment" name="comment" rows="4"
                                                required></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary rounded-pill">Gửi đánh giá</button>
                                    </form>
                                </div>
                                <% } else { %>
                                    <div class="alert alert-info" role="alert">
                                        Vui lòng <a href="/login" class="alert-link">đăng nhập</a> để để lại đánh giá.
                                    </div>
                                    <% } %>

                                        <!-- Danh sách các đánh giá đã có -->
                                        <div class="review-list">
                                            <h4 class="mb-3">Các đánh giá trước đây</h4>
                                            <% if (reviews && reviews.length> 0) { %>
                                                <% reviews.forEach(function(review) { %>
                                                    <div class="review-item">
                                                        <div class="review-header">
                                                            <div class="avatar">
                                                                <%= review.user.name.charAt(0).toUpperCase() %>
                                                            </div>
                                                            <div>
                                                                <h6 class="mb-0 fw-bold">
                                                                    <%= review.user.name %>
                                                                </h6>

                                                                <small class="text-muted">
                                                                    <%= new
                                                                        Date(review.createdAt).toLocaleDateString('vi-VN')
                                                                        %>
                                                                </small>
                                                            </div>
                                                        </div>
                                                        <div class="review-body">
                                                            <div class="review-stars mb-2">
                                                                <% for(let i=0; i < 5; i++) { %>
                                                                    <i
                                                                        class="fas fa-star<%= i < review.rating ? '' : '-o' %>"></i>
                                                                    <% } %>
                                                            </div>
                                                            <p>
                                                                <%= review.comment %>
                                                            </p>
                                                        </div>
                                                    </div>
                                                    <% }); %>
                                                        <% } else { %>
                                                            <p>Chưa có đánh giá nào cho sản phẩm này. Hãy là người đầu
                                                                tiên đánh giá!</p>
                                                            <% } %>
                                        </div>
                        </div>
                    </div>
                </div>
                <!-- END: REVIEW SECTION -->
            </div>
        </div>
        <%- include('../layout/footer'); -%>

            <!-- 3D Model Viewer Modal -->
            <div class="modal fade modal-3d-viewer" id="model3dModal" tabindex="-1" aria-labelledby="model3dModalLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="model3dModalLabel">Vuốt hoặc kéo thả để xoay mô hình 3D</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <iframe id="model3d-iframe" src="" allowfullscreen></iframe>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Image Viewer Modal -->
            <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl modal-dialog-centered">
                    <div class="modal-content bg-transparent border-0">
                        <div class="modal-header border-0">
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-0 text-center">
                            <img id="modal-image-content" src="" class="img-fluid" alt="Product Image"
                                style="max-height: 80vh;">
                        </div>
                    </div>
                </div>
            </div>





            <a href="#" class="btn btn-primary border-3 border-primary rounded-circle back-to-top"><i
                    class="fa fa-arrow-up"></i></a>


            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
            <script src="/client/lib/easing/easing.min.js"></script>
            <script src="/client/lib/waypoints/waypoints.min.js"></script>
            <script src="/client/lib/owlcarousel/owl.carousel.min.js"></script>

            <script src="/client/js/main.js"></script>

            <script>
                // Logic JS đơn giản để làm nổi bật biến thể đã chọn
                document.addEventListener('DOMContentLoaded', function () {
                    // Xử lý modal xem ảnh
                    const imageModal = document.getElementById('imageModal');
                    if (imageModal) {
                        imageModal.addEventListener('show.bs.modal', function (event) {
                            const triggerElement = event.relatedTarget;
                            const imageSrc = triggerElement.getAttribute('data-image-src');
                            const modalImage = document.getElementById('modal-image-content');
                            modalImage.src = imageSrc;
                        });
                    }

                    const variantButtons = document.querySelectorAll('.variant-selection');
                    const priceDisplay = document.getElementById('variant-price-display');
                    const originalPriceDisplay = document.getElementById('variant-original-price-display');
                    const priceContainer = document.getElementById('price-container');
                    const view3dBtn = document.getElementById('view-3d-btn');
                    const specRam = document.getElementById('spec-ram');
                    const specStorage = document.getElementById('spec-storage');
                    const selectedVariantIdInput = document.getElementById('selectedVariantId');
                    const stockDisplay = document.getElementById('variant-stock-display');
                    const quantityInput = document.getElementById('quantityInput');
                    const addToCartBtn = document.getElementById('addToCartBtn');

                    const formatCurrency = (value) => {
                        return new Intl.NumberFormat('vi-VN', {
                            style: 'currency',
                            currency: 'VND'
                        }).format(value);
                    };

                    const updatePriceDisplay = (button) => {
                        const price = parseFloat(button.getAttribute('data-price'));
                        const discount = parseFloat(button.getAttribute('data-discount') || '0');
                        const originalPrice = parseFloat(button.getAttribute('data-original-price') || price);
                        const finalPrice = price * (1 - discount / 100);

                        if (price <= 0) {
                            priceDisplay.textContent = 'Giá: Liên hệ';
                            if (originalPriceDisplay) originalPriceDisplay.style.display = 'none';
                            return;
                        }

                        priceDisplay.textContent = formatCurrency(finalPrice);

                        if (discount > 0 && originalPriceDisplay) {
                            originalPriceDisplay.textContent = formatCurrency(originalPrice);
                            originalPriceDisplay.style.display = 'inline';
                        } else if (originalPriceDisplay) {
                            originalPriceDisplay.style.display = 'none';
                        }
                    };

                    const update3dButton = (button) => {
                        const modelUrl = button.getAttribute('data-model-url');
                        if (modelUrl && view3dBtn) {
                            view3dBtn.setAttribute('data-model-src', modelUrl);
                            view3dBtn.style.display = 'inline-block';
                        } else if (view3dBtn) {
                            view3dBtn.style.display = 'none';
                        }
                    }

                    const updateSpecs = (button) => {
                        const ram = button.getAttribute('data-ram');
                        const storage = button.getAttribute('data-storage');

                        if (specRam) {
                            specRam.textContent = ram;
                        }
                        if (specStorage) {
                            specStorage.textContent = storage;
                        }
                    }

                    const updateStockAndAvailability = (button) => {
                        const stock = parseInt(button.getAttribute('data-stock') || '0');

                        if (stockDisplay) {
                            stockDisplay.textContent = stock > 0 ? stock : 'Hết hàng';
                        }

                        if (quantityInput) {
                            quantityInput.setAttribute('max', stock);
                            if (quantityInput.value > stock) {
                                quantityInput.value = stock > 0 ? stock : 1;
                            }
                        }

                        if (addToCartBtn) {
                            addToCartBtn.disabled = stock <= 0;
                            addToCartBtn.style.cursor = stock <= 0 ? 'not-allowed' : 'pointer';
                        }
                    };

                    // Mặc định chọn biến thể đầu tiên (nếu có)
                    if (variantButtons.length > 0) {
                        let isInitiallySelected = Array.from(variantButtons).some(btn => btn.classList.contains('btn-primary'));

                        if (!isInitiallySelected) {
                            const firstButton = variantButtons[0];
                            firstButton.classList.remove('btn-outline-secondary');
                            firstButton.classList.add('btn-primary');

                            if (selectedVariantIdInput) {
                                selectedVariantIdInput.value = firstButton.getAttribute('data-variant-id');
                            }

                            updatePriceDisplay(firstButton);
                            update3dButton(firstButton);
                            updateSpecs(firstButton);
                            updateStockAndAvailability(firstButton);
                        }
                    }

                    // Xử lý sự kiện click cho các nút biến thể
                    variantButtons.forEach(button => {
                        button.addEventListener('click', function (e) {
                            e.preventDefault();

                            variantButtons.forEach(btn => {
                                btn.classList.remove('btn-primary');
                                btn.classList.add('btn-outline-secondary');
                            });

                            this.classList.remove('btn-outline-secondary');
                            this.classList.add('btn-primary');

                            if (selectedVariantIdInput) {
                                selectedVariantIdInput.value = this.getAttribute('data-variant-id');
                            }

                            updatePriceDisplay(this);
                            update3dButton(this);
                            updateSpecs(this);
                            updateStockAndAvailability(this);
                        });
                    });

                    // Xử lý modal 3D
                    const model3dModal = document.getElementById('model3dModal');
                    if (model3dModal) {
                        model3dModal.addEventListener('show.bs.modal', function (event) {
                            const button = event.relatedTarget;
                            const modelSrc = button.getAttribute('data-model-src');
                            const iframe = document.getElementById('model3d-iframe');
                            iframe.setAttribute('src', modelSrc);
                        });

                        model3dModal.addEventListener('hide.bs.modal', function () {
                            const iframe = document.getElementById('model3d-iframe');
                            iframe.setAttribute('src', '');
                        });
                    }
                });
            </script>

</body>

</html>
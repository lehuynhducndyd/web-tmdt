<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>
        <%= product.name %> - Chi tiết sản phẩm
    </title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Raleway:wght@600;800&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <link href="/client/lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">
    <link href="/client/lib/lightbox/css/lightbox.min.css" rel="stylesheet">

    <link href="/client/css/bootstrap.min.css" rel="stylesheet">

    <link href="/client/css/style.css" rel="stylesheet">

<style>
    #shop-detail-page {
        background-color: #f8f9fa;
    }

    /* KHẮC PHỤC BỐ CỤC CỘT QUAN TRỌNG START */
    /* Đảm bảo hàng chính là Flexbox container */
    #shop-detail-page .row.g-4.mb-5 {
        display: flex;
        flex-wrap: wrap;
        /* Cho phép các cột xuống dòng nếu cần */
        align-items: flex-start;
        /* Căn chỉnh các cột lên trên cùng */
        margin: 0 -15px;
        /* Sửa lỗi margin âm của row */
    }

    /* Cột ảnh (col-xl-4) */
    #shop-detail-page .col-xl-4 {
        flex: 0 0 33.333333%;
        max-width: 33.333333%;
        padding: 15px;
    }

    /* Cột thông tin sản phẩm (col-xl-5) */
    #shop-detail-page .col-xl-5 {
        flex: 0 0 41.666667%;
        max-width: 41.666667%;
        padding: 15px 20px;
    }

    /* Cột thông số kỹ thuật (col-xl-3) */
    #shop-detail-page .col-xl-3 {
        flex: 0 0 25%;
        max-width: 25%;
        padding: 25px;
        background: #ffffff;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        font-size: 0.9rem;
    }

    /* KHẮC PHỤC BỐ CỤC CỘT QUAN TRỌNG END */

    /* Cải thiện hiển thị văn bản tràn */
    #shop-detail-page h1,
    #shop-detail-page h5 {
        white-space: normal;
        /* Cho phép tiêu đề xuống dòng */
        word-break: break-word;
    }

    /* Cải thiện các thành phần nhỏ */

    #shop-detail-page h1 {
        font-size: 2.5rem;
        /* Giảm nhẹ kích thước */
        font-weight: 800 !important;
        color: #333;
        margin-top: 0;
    }

    #shop-detail-page #variant-price-display {
        font-size: 1.8rem;
        color: #d63384 !important;
        margin-bottom: 20px !important;
        padding-bottom: 5px;
        border-bottom: 2px solid #eee;
    }

    #shop-detail-page .variant-selection {
        font-size: 0.9rem;
        padding: 10px 18px;
        transition: all 0.3s ease;
        font-weight: 600;
        border-color: #ced4da !important;
    }

    #shop-detail-page .variant-selection:hover,
    #shop-detail-page .btn-primary,
    #shop-detail-page .variant-selection.btn-primary {
        background-color: #007bff !important;
        border-color: #007bff !important;
        color: white !important;
    }

    #shop-detail-page .d-flex.mb-4 small {
        /* Sửa lỗi tràn dòng thương hiệu/danh mục */
        line-height: 1.4;
    }

    #shop-detail-page .list-unstyled li {
        padding: 5px 0;
        border-bottom: 1px dashed #eee;
    }

    #shop-detail-page .list-unstyled li i {
        color: #007bff !important;
    }

    #shop-detail-page .rounded {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    #shop-detail-page .container-fluid.py-5.mt-5 {
        margin-top: 5rem !important;
        padding-top: 4rem !important;
    }
</style>
</head>

<body id="shop-detail-page">
    <%- include('../layout/navbar'); -%>

        <div class="container-fluid ">
            <div class="container py-5">
                <div class="row g-4 mb-5">
                    <div class="col-lg-8 col-xl-4">
                        <div class="image-gallery">
                            <div class="main-image position-relative overflow-hidden rounded">
                                <% const mainImageUrl = (product.thumbnail && product.thumbnail.data) ? `data:${product.thumbnail.contentType};base64,${product.thumbnail.data.toString('base64')}` : '/admin/img/default-image.png'; %>
                                <img src="<%= mainImageUrl %>" class="img-fluid w-100" alt="<%= product.name %>" id="main-product-image" style="height: 450px; object-fit: contain; cursor: pointer;">
                            </div>
                            <div class="image-gallery-thumbnails">
                                <!-- Main Thumbnail -->
                                <div class="thumbnail-item active">
                                    <img src="<%= mainImageUrl %>" alt="Thumbnail 0" onclick="document.getElementById('main-product-image').src='<%= mainImageUrl %>'; document.querySelector('.thumbnail-item.active').classList.remove('active'); this.parentElement.classList.add('active');">
                                </div>
                                <!-- Additional Images -->
                                <% if (product.images && product.images.length > 0) { %>
                                    <% product.images.forEach(function(image, index) { %>
                                        <% const imageUrl = `data:${image.contentType};base64,${image.data.toString('base64')}`; %>
                                        <div class="thumbnail-item">
                                            <!-- Hidden link for lightbox gallery -->
                                            <a href="<%= imageUrl %>" data-lightbox="product-gallery" data-title="<%= product.name %> - Ảnh <%= index + 1 %>" style="display:none;"></a>
                                            <!-- Visible thumbnail -->
                                            <img src="<%= imageUrl %>" alt="Thumbnail <%= index + 1 %>" onclick="document.getElementById('main-product-image').src='<%= imageUrl %>'; document.querySelector('.thumbnail-item.active').classList.remove('active'); this.parentElement.classList.add('active');">
                                        </div>
                                    <% }); %>
                                <% } %>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-8 col-xl-5">
                        <h1 class="fw-bold mb-3">
                            <%= product.name %>
                        </h1>
                        <div class="d-flex mb-4">
                            <small class="me-3"><i class="fas fa-box text-warning me-2"></i>Thương hiệu: <strong>
                                    <%= product.brand ? product.brand.name : 'N/A' %>
                                </strong></small>
                            <small><i class="fas fa-list-alt text-warning me-2"></i>Danh mục: <strong>
                                    <%= product.category ? product.category.name : 'N/A' %>
                                </strong></small>
                        </div>

                        <% if (product.price> 0) { %>
                            <h4 class="fw-bold text-primary mb-4" id="variant-price-display">
                                Giá từ: <%= new Intl.NumberFormat('vi-VN', { style: 'currency' , currency: 'VND'
                                    }).format(product.price) %>
                            </h4>
                            <% } else { %>
                                <h4 class="fw-bold text-primary mb-4" id="variant-price-display">Giá: Liên hệ</h4>
                                <% } %>

                                <p class="mb-4">
                                    <strong>Mô tả ngắn:</strong>
                                    <%= product.description %>
                                </p>

                                    <h5 class="fw-bold mt-4">Chọn Phiên bản:</h5>
                                    <div class="d-flex flex-wrap mb-4">
                                        <% variants.forEach(function(variant){ %>
                                            <a href="#"
                                                class="btn btn-outline-secondary rounded-pill me-2 mb-2 variant-selection" data-model-url="<%= variant.model3d %>"
                                                data-color="<%= variant.color %>" data-ram="<%= variant.RAM %>"
                                                data-storage="<%= variant.storage %>" data-price="<%= variant.price %>">
                                                <%= variant.color %> | 8GB/<%= variant.storage %>
                                            </a>
                                            <% }); %>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <div class="input-group quantity me-4" style="width: 120px;">
                                            <div class="input-group-btn">
                                                <button class="btn-sm btn-minus rounded-circle bg-light border">
                                                    <i class="fa fa-minus"></i>
                                                </button>
                                            </div>
                                            <input type="text" class="form-control form-control-sm text-center border-0"
                                                value="1" id="quantityInput">
                                            <div class="input-group-btn">
                                                <button class="btn-sm btn-plus rounded-circle bg-light border">
                                                    <i class="fa fa-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <a href="#" id="view-3d-btn" class="btn btn-warning rounded-pill px-4 py-2 me-3" data-bs-toggle="modal" data-bs-target="#model3dModal" style="display: none;">
                                            <i class="fas fa-cube me-2"></i> Xem 3D
                                        </a>
                                        <a href="#"
                                            class="btn border border-secondary rounded-pill px-4 py-2 text-primary">
                                            <i class="fa fa-shopping-bag me-2 text-primary"></i> Thêm vào giỏ
                                        </a>
                                    </div>
                    </div>

                    <div class="col-lg-12 col-xl-3">
                        <h5 class="fw-bold mb-4">Chi tiết sản phẩm</h5>
                        <p>
                            <%= product.detail %>
                        </p>

                        <h5 class="fw-bold mt-4">Thông số kỹ thuật chính:</h5>
                        <ul class="list-unstyled">
                            <% if (product.variants && product.variants.length> 0) { %>
                                <li><i class="fas fa-check text-success me-2"></i>RAM: <strong><%= product.variants[0].RAM %></strong>
                                        trở lên</li>
                                <li><i class="fas fa-check text-success me-2"></i>Bộ nhớ: <strong><%=
                                        product.variants[0].storage %></strong> trở lên</li>
                                <% } %>
                                    <li><i class="fas fa-check text-success me-2"></i>Thương hiệu: <strong><%= product.brand ?
                                            product.brand.name : 'N/A' %></strong></li>
                        </ul>
                    </div>
                </div>

                <div class="container-fluid fruite py-5">
                    <div class="container py-5 fruite">
                        <h1 class="fw-bold mb-4">Sản phẩm liên quan</h1>
                        <div class="row g-4">
                            <% relatedProducts.forEach(function(relatedProduct){ %>
                                <div class="col-md-6 col-lg-4 col-xl-3">
                                    <a href="/shop-detail/<%= relatedProduct._id %>" class="product-card-link">
                                        <div class="rounded position-relative fruite-item border border-light-subtle rounded-bottom">
                                            <div class="product-image-container">
                                                <% if (relatedProduct.thumbnail && relatedProduct.thumbnail.data) { %>
                                                    <img src="data:<%= relatedProduct.thumbnail.contentType %>;base64,<%= relatedProduct.thumbnail.data.toString('base64') %>"
                                                        class="img-fluid" alt="<%= relatedProduct.name %>"
                                                        style="max-height: 100%; max-width: 100%; object-fit: contain;">
                                                    <% } else { %>
                                                        <img src="/admin/img/default-image.png" class="img-fluid" alt="No Image"
                                                            style="max-height: 100%; max-width: 100%; object-fit: contain;">
                                                        <% } %>
                                            </div>
                                            <div class="p-4">
                                                <h4>
                                                    <p style="font-size: 15px;">
                                                        <%= relatedProduct.name %>
                                                    </p>
                                                </h4>
                                                <div class="d-flex flex-lg-wrap">
                                                    <p class="text-dark fs-5 fw-bold mb-3" style="font-size: 15px; text-align: center; width: 100%;">
                                                        <% if (relatedProduct.price > 0) { %>
                                                            <%= new Intl.NumberFormat('vi-VN', { style: 'currency' , currency: 'VND' }).format(relatedProduct.price) %>
                                                        <% } else { %>
                                                            Liên hệ
                                                        <% } %>
                                                    </p>
                                                    <a href="/shop-detail/<%= relatedProduct._id %>" class="btn border border-secondary rounded-pill px-3 text-primary mx-auto">
                                                        <i class="fa fa-shopping-bag me-2 text-primary"></i> Xem chi tiết
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                                <% }); %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <%- include('../layout/footer'); -%>

        <!-- 3D Model Viewer Modal -->
        <div class="modal fade modal-3d-viewer" id="model3dModal" tabindex="-1" aria-labelledby="model3dModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="model3dModalLabel">Trình xem mô hình 3D</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <iframe id="model3d-iframe" src="" allowfullscreen></iframe>
                    </div>
                </div>
            </div>
        </div>



            <a href="#" class="btn btn-primary border-3 border-primary rounded-circle back-to-top"><i
                    class="fa fa-arrow-up"></i></a>


            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
            <script src="/client/lib/easing/easing.min.js"></script>
            <script src="/client/lib/waypoints/waypoints.min.js"></script>
            <script src="/client/lib/lightbox/js/lightbox.min.js"></script>
            <script src="/client/lib/owlcarousel/owl.carousel.min.js"></script>

            <script src="/client/js/main.js"></script>

            <script>
                // Logic JS đơn giản để làm nổi bật biến thể đã chọn
                document.addEventListener('DOMContentLoaded', function () {
                    // Lightbox2 options
                    lightbox.option({
                        'resizeDuration': 200,
                        'wrapAround': true
                    });

                    // Mở lightbox khi click vào ảnh chính
                    const mainImage = document.getElementById('main-product-image');
                    if (mainImage) {
                        mainImage.addEventListener('click', function() {
                            const firstGalleryImage = document.querySelector('a[data-lightbox="product-gallery"]');
                            if (firstGalleryImage) {
                                firstGalleryImage.click();
                            }
                        });
                    }

                    const variantButtons = document.querySelectorAll('.variant-selection');
                    const priceDisplay = document.getElementById('variant-price-display');
                    const view3dBtn = document.getElementById('view-3d-btn');

                    const formatCurrency = (price) => {
                        if (price <= 0 || isNaN(price)) {
                            return 'Giá: Liên hệ';
                        }
                        return 'Giá từ: ' + new Intl.NumberFormat('vi-VN', {
                            style: 'currency',
                            currency: 'VND'
                        }).format(price);
                    };

                    const update3dButton = (button) => {
                        const modelUrl = button.getAttribute('data-model-url');
                        if (modelUrl && view3dBtn) {
                            view3dBtn.setAttribute('data-model-src', modelUrl);
                            view3dBtn.style.display = 'inline-block';
                        } else if (view3dBtn) {
                            view3dBtn.style.display = 'none';
                        }
                    }

                    // Mặc định chọn biến thể đầu tiên (nếu có)
                    if (variantButtons.length > 0) {
                        let isInitiallySelected = Array.from(variantButtons).some(btn => btn.classList.contains('btn-primary'));

                        if (!isInitiallySelected) {
                            const firstButton = variantButtons[0];
                            firstButton.classList.remove('btn-outline-secondary');
                            firstButton.classList.add('btn-primary');

                            const initialPrice = parseFloat(firstButton.getAttribute('data-price'));
                            if (priceDisplay) {
                                priceDisplay.textContent = formatCurrency(initialPrice);
                            }
                            update3dButton(firstButton);
                        }
                    }

                    // Xử lý sự kiện click cho các nút biến thể
                    variantButtons.forEach(button => {
                        button.addEventListener('click', function (e) {
                            e.preventDefault();

                            variantButtons.forEach(btn => {
                                btn.classList.remove('btn-primary');
                                btn.classList.add('btn-outline-secondary');
                            });

                            this.classList.remove('btn-outline-secondary');
                            this.classList.add('btn-primary');

                            const selectedPrice = parseFloat(this.getAttribute('data-price'));
                            if (priceDisplay) {
                                priceDisplay.textContent = formatCurrency(selectedPrice);
                            }

                            update3dButton(this);
                        });
                    });

                    // Xử lý modal 3D
                    const model3dModal = document.getElementById('model3dModal');
                    if (model3dModal) {
                        model3dModal.addEventListener('show.bs.modal', function (event) {
                            const button = event.relatedTarget;
                            const modelSrc = button.getAttribute('data-model-src');
                            const iframe = document.getElementById('model3d-iframe');
                            iframe.setAttribute('src', modelSrc);
                        });

                        model3dModal.addEventListener('hide.bs.modal', function () {
                            const iframe = document.getElementById('model3d-iframe');
                            iframe.setAttribute('src', ''); // Dừng load iframe khi đóng modal
                        });
                    }
                });
            </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Giỏ hàng</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Raleway:wght@600;800&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <link href="/client/css/bootstrap.min.css" rel="stylesheet">
    <link href="/client/css/style.css" rel="stylesheet">

    <style>
        /* CSS dành riêng cho Mobile (màn hình < 768px) */
        @media screen and (max-width: 768px) {

            /* 1. Ẩn header của bảng */
            .table thead {
                display: none;
            }

            /* 2. Biến mỗi dòng (tr) thành một cái thẻ (card) */
            .table tbody tr {
                display: block;
                margin-bottom: 1.5rem;
                background-color: #fff;
                border: 1px solid #ddd;
                border-radius: 10px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
                overflow: hidden;
            }

            /* 3. Biến mỗi ô (td) thành một dòng flex */
            .table tbody td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.75rem 1rem;
                border-bottom: 1px solid #f0f0f0;
                text-align: right;
                min-height: 50px;
            }

            /* Loại bỏ border dòng cuối cùng trong card */
            .table tbody td:last-child {
                border-bottom: none;
                padding-bottom: 1rem;
            }

            /* 4. Sử dụng data-label để tạo tiêu đề giả bên trái */
            .table tbody td::before {
                content: attr(data-label);
                font-weight: 700;
                color: #555;
                text-transform: uppercase;
                font-size: 0.85rem;
                text-align: left;
                margin-right: auto;
            }

            /* --- Tùy chỉnh đặc biệt cho từng cột --- */

            /* Cột Hình ảnh: Căn giữa và làm nền khác biệt */
            .table tbody td:first-child {
                justify-content: center;
                background-color: #f8f9fa;
                padding: 1rem;
            }

            .table tbody td:first-child::before {
                display: none;
                /* Ẩn label cho ảnh */
            }

            /* Cột Tên sản phẩm: Hiển thị full dòng */
            .table tbody td:nth-child(2) {
                display: block;
                text-align: left;
            }

            .table tbody td:nth-child(2)::before {
                display: none;
            }

            /* Input số lượng: Mở rộng chiều ngang */
            /* Input số lượng: Mở rộng chiều ngang và ép không xuống dòng */
            .quantity {
                width: 140px !important;
                display: flex !important;
                flex-wrap: nowrap !important;
                /* Quan trọng: Ngăn xuống dòng */
                align-items: center;
            }

            /* Đảm bảo input ở giữa không bị quá to làm đẩy nút ra ngoài */
            .quantity input {
                flex: 1;
                min-width: 40px;
                text-align: center;
            }

            /* Nút xóa: Làm to ra để dễ bấm */
            .btn-remove-mobile {
                width: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            }
        }
    </style>
</head>

<body>
    <%- include('../layout/navbar'); -%>

        <div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-fullscreen">
                <div class="modal-content rounded-0">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Search by keyword</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body d-flex align-items-center">
                        <div class="input-group w-75 mx-auto d-flex">
                            <input type="search" class="form-control p-3" placeholder="keywords"
                                aria-describedby="search-icon-1">
                            <span id="search-icon-1" class="input-group-text p-3"><i class="fa fa-search"></i></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid py-5">
            <div class="container py-5">

                <h3 class="text-center mb-4">Giỏ hàng của bạn</h3>
                <form action="/update-and-checkout" method="post">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th scope="col" style="width: 150px;">Hình ảnh</th>
                                    <th scope="col">Tên sản phẩm</th>
                                    <th scope="col">Giá</th>
                                    <th scope="col">Số lượng</th>
                                    <th scope="col">Thành tiền</th>
                                    <th scope="col">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (cart && cart.items && cart.items.length> 0) { %>
                                    <% cart.items.forEach(function(item) { %>
                                        <tr class="align-items-center">
                                            <td>
                                                <div
                                                    class="d-flex align-items-center justify-content-center justify-content-md-start">
                                                    <% if (item.product.thumbnail && item.product.thumbnail.data) { %>
                                                        <img src="data:<%= item.product.thumbnail.contentType %>;base64,<%= item.product.thumbnail.data.toString('base64') %>"
                                                            class="img-fluid rounded"
                                                            style="width: 80px; height: 80px; object-fit: contain;"
                                                            alt="<%= item.product.name %>">
                                                        <% } else { %>
                                                            <img src="/admin/img/default-image.png"
                                                                class="img-fluid rounded"
                                                                style="width: 80px; height: 80px; object-fit: contain;"
                                                                alt="No Image">
                                                            <% } %>
                                                </div>
                                            </td>

                                            <td data-label="Sản phẩm">
                                                <p class="mb-1 fw-bold text-dark" style="font-size: 1.1rem;">
                                                    <%= item.product.name %>
                                                </p>
                                                <small class="text-muted d-block">
                                                    Màu: <%= item.variant.color %>
                                                        <% if (item.variant.ram && item.variant.storage) { %>
                                                            | <%= item.variant.ram %> / <%= item.variant.storage %>
                                                                    <% } %>
                                                </small>
                                            </td>

                                            <td data-label="Đơn giá">
                                                <% const finalPrice=item.variant.price * (1 - (item.variant.discount ||
                                                    0) / 100); %>
                                                    <div
                                                        class="d-flex flex-column align-items-end align-items-md-start">
                                                        <% if (item.variant.discount && item.variant.discount> 0) { %>
                                                            <span class="text-danger fw-bold">
                                                                <%= new Intl.NumberFormat('vi-VN', { style: 'currency' ,
                                                                    currency: 'VND' }).format(finalPrice) %>
                                                            </span>
                                                            <span class="text-muted text-decoration-line-through"
                                                                style="font-size: 0.85em;">
                                                                <%= new Intl.NumberFormat('vi-VN', { style: 'currency' ,
                                                                    currency: 'VND' }).format(item.variant.price) %>
                                                            </span>
                                                            <% } else { %>
                                                                <span class="fw-bold">
                                                                    <%= new Intl.NumberFormat('vi-VN', {
                                                                        style: 'currency' , currency: 'VND'
                                                                        }).format(item.variant.price) %>
                                                                </span>
                                                                <% } %>
                                                    </div>
                                            </td>

                                            <td data-label="Số lượng">
                                                <div class="input-group quantity ms-auto ms-md-0 d-flex flex-nowrap align-items-center"
                                                    style="width: 120px;">
                                                    <button
                                                        class="btn btn-sm btn-minus rounded-start bg-light border border-end-0"
                                                        type="button"
                                                        style="height: 31px; display: flex; align-items: center;">
                                                        <i class="fa fa-minus" style="font-size: 0.8rem;"></i>
                                                    </button>

                                                    <input type="number"
                                                        class="form-control form-control-sm text-center border-top border-bottom border-start-0 border-end-0"
                                                        style="height: 31px; margin: 0; min-width: 40px;"
                                                        value="<%= item.quantity %>" min="1"
                                                        max="<%= item.variant.stock %>"
                                                        data-variant-id="<%= item.variantId %>"
                                                        name="quantities[<%= item.variantId %>]">

                                                    <button
                                                        class="btn btn-sm btn-plus rounded-end bg-light border border-start-0"
                                                        type="button"
                                                        style="height: 31px; display: flex; align-items: center;">
                                                        <i class="fa fa-plus" style="font-size: 0.8rem;"></i>
                                                    </button>
                                                </div>
                                            </td>

                                            <td data-label="Thành tiền" class="item-total"
                                                data-price="<%= finalPrice %>">
                                                <p class="mb-0 fw-bold text-primary">
                                                    <%= new Intl.NumberFormat('vi-VN', { style: 'currency' ,
                                                        currency: 'VND' }).format(finalPrice * item.quantity) %>
                                                </p>
                                            </td>

                                            <td data-label="Thao tác">
                                                <button type="submit"
                                                    formaction="/delete-cart-item/<%= item.variantId %>"
                                                    class="btn btn-md btn-light border text-danger btn-remove-mobile">
                                                    <i class="fa fa-times"></i>
                                                    <span class="d-md-none fw-bold">Xóa khỏi giỏ</span>
                                                </button>
                                            </td>
                                        </tr>
                                        <% }); %>
                                            <% } else { %>
                                                <tr>
                                                    <td colspan="6" class="text-center py-5">
                                                        <div
                                                            class="d-flex flex-column align-items-center justify-content-center">
                                                            <i class="bi bi-cart-x display-1 text-secondary mb-3"></i>
                                                            <h4>Giỏ hàng của bạn đang trống!</h4>
                                                            <p class="text-muted">Hãy thêm sản phẩm để tiếp tục mua sắm.
                                                            </p>
                                                            <a href="/"
                                                                class="btn btn-primary rounded-pill px-4 py-2 mt-2">Về
                                                                trang chủ</a>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <% } %>
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-5 row g-4 justify-content-start">
                        <div class="col-12 col-md-8">
                            <div class="bg-light rounded">
                                <div class="p-4">
                                    <h1 class="display-6 mb-4">Tổng cộng
                                        <span id="cart-total" class="text-danger float-end float-md-none ms-md-3">
                                            <%= new Intl.NumberFormat('vi-VN', { style: 'currency' , currency: 'VND'
                                                }).format(cart ? cart.subTotal : 0) %>
                                        </span>
                                    </h1>
                                </div>

                                <button class="btn btn-warning rounded-pill px-4 py-3 mb-4 ms-4 w-75 w-md-auto"
                                    type="submit">
                                    Xác nhận mua hàng
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <%- include('../layout/footer'); -%>

            <a href="#" class="btn btn-primary border-3 border-primary rounded-circle back-to-top"><i
                    class="fa fa-arrow-up"></i></a>


            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
            <script src="lib/easing/easing.min.js"></script>
            <script src="lib/waypoints/waypoints.min.js"></script>
            <script src="lib/lightbox/js/lightbox.min.js"></script>
            <script src="lib/owlcarousel/owl.carousel.min.js"></script>

            <script src="js/main.js"></script>

            <script>
                $(document).ready(function () {
                    const formatCurrency = (value) => {
                        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);
                    };

                    function updateCartTotals() {
                        let subTotal = 0;
                        $('tbody tr').each(function () {
                            const row = $(this);
                            const quantityInput = row.find('.quantity input');

                            // Chỉ tính toán nếu row đó có sản phẩm (tránh row thông báo giỏ hàng trống)
                            if (quantityInput.length > 0) {
                                const price = parseFloat(row.find('.item-total').data('price'));
                                const quantity = parseInt(quantityInput.val());
                                const itemTotal = price * quantity;
                                subTotal += itemTotal;

                                // Cập nhật tổng tiền của từng sản phẩm
                                row.find('.item-total p').text(formatCurrency(itemTotal));
                            }
                        });

                        // Cập nhật Tổng cộng
                        $('#cart-total').text(formatCurrency(subTotal));
                    }

                    function updateCartOnServer(variantId, quantity) {
                        fetch('/update-cart-quantity', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                variantId: variantId,
                                quantity: quantity
                            })
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (!data.success) {
                                    console.error('Failed to update cart:', data.message);
                                    // Có thể thêm alert báo lỗi ở đây nếu muốn
                                }
                            })
                            .catch(error => console.error('Error:', error));
                    }

                    // Xử lý sự kiện click nút cộng
                    $('.btn-plus').on('click', function () {
                        const input = $(this).closest('.quantity').find('input');
                        let currentValue = parseInt(input.val());
                        const max = parseInt(input.attr('max'));

                        if (currentValue < max) {
                            const newValue = currentValue + 1;
                            input.val(newValue);
                            // Gọi trực tiếp hàm update thay vì trigger change để tránh lặp logic nếu có
                            updateCartTotals();
                            const variantId = input.data('variant-id');
                            updateCartOnServer(variantId, newValue);
                        }
                    });

                    // Xử lý sự kiện click nút trừ
                    $('.btn-minus').on('click', function () {
                        const input = $(this).closest('.quantity').find('input');
                        let currentValue = parseInt(input.val());
                        const min = parseInt(input.attr('min'));

                        if (currentValue > min) {
                            const newValue = currentValue - 1;
                            input.val(newValue);
                            updateCartTotals();
                            const variantId = input.data('variant-id');
                            updateCartOnServer(variantId, newValue);
                        }
                    });

                    // Bắt sự kiện khi người dùng tự nhập số vào ô input
                    $('.quantity input').on('change', function () {
                        let val = parseInt($(this).val());
                        const min = parseInt($(this).attr('min'));
                        const max = parseInt($(this).attr('max'));

                        // Validate số nhập vào
                        if (isNaN(val) || val < min) val = min;
                        if (val > max) val = max;

                        $(this).val(val); // Reset lại giá trị hợp lệ vào ô input

                        updateCartTotals();
                        const variantId = $(this).data('variant-id');
                        updateCartOnServer(variantId, val);
                    });

                });
            </script>
</body>

</html>
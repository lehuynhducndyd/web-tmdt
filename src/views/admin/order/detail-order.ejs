<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="  - Dự án laptopshop" />
    <meta name="author" content=" " />
    <title>Chi tiết đơn đặt hàng</title>
    <link href="/admin/css/styles.css" rel="stylesheet" />
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
</head>

<body class="sb-nav-fixed">
    <%- include('../layout/header'); -%>
        <div id="layoutSidenav">
            <%- include('../layout/sidenav'); -%>
                <div id="layoutSidenav_content">
                    <main>
                        <div class="container-fluid px-4">
                            <h1 class="mt-4">Quản lý đơn đặt hàng</h1>
                            <ol class="breadcrumb mb-4">
                                <li class="breadcrumb-item"><a href="/admin">Trang chủ</a></li>
                                <li class="breadcrumb-item active">Đơn đặt hàng</li>
                            </ol>
                            <div>
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Chi tiết đơn hàng #<%= order._id %>
                                        </h5>

                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6>Thông tin khách hàng</h6>
                                                <p><strong>Tên khách hàng:</strong>
                                                    <%= order.customer.name %>
                                                </p>
                                                <p><strong>Email:</strong>
                                                    <%= order.customer.email %>
                                                </p>
                                                <p><strong>Số điện thoại:</strong>
                                                    <%= order.shippingAddress.phone %>
                                                </p>
                                                <p><strong>Địa chỉ:</strong>
                                                    <%= `${order.shippingAddress.street},
                                                        ${order.shippingAddress.commune},
                                                        ${order.shippingAddress.province}` %>
                                                </p>
                                            </div>
                                            <div class="col-md-6">
                                                <h6>Thông tin đơn hàng</h6>
                                                <p><strong>Tổng tiền:</strong> <span class="text-danger fw-bold">
                                                        <%= new Intl.NumberFormat('vi-VN', { style: 'currency' ,
                                                            currency: 'VND' }).format(order.totalAmount) %>
                                                    </span></p>
                                                <p><strong>Phương thức thanh toán:</strong>
                                                    <%= order.paymentMethod %>
                                                </p>





                                                <p><strong>Ngày đặt:</strong>
                                                    <%= new Date(order.createdAt).toLocaleDateString('vi-VN') %>
                                                </p>
                                                <form action="/admin/order/<%= order._id %>/update-status" method="post"
                                                    class="d-flex align-items-center">
                                                    <div class="row">
                                                        <div class="col-md-12 ">
                                                            <label for="paymentStatus" class="me-2"><strong>Trạng thái
                                                                    thanh
                                                                    toán:</strong></label>
                                                            <select name="paymentStatus" id="paymentStatus"
                                                                class="form-select" style="width: 180px;">
                                                                <option value="pending"
                                                                    <%=order.paymentStatus==='pending' ? 'selected' : ''
                                                                    %>>Chờ thanh toán</option>
                                                                <option value="paid" <%=order.paymentStatus==='paid'
                                                                    ? 'selected' : '' %>>Đã thanh toán</option>
                                                                <option value="failed" <%=order.paymentStatus==='failed'
                                                                    ? 'selected' : '' %>>Thất bại</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-md-12 py-2">
                                                            <label for="status" class="me-2"><strong>Trạng
                                                                    thái:</strong></label>
                                                            <select name="status" id="status" class="form-select"
                                                                style="width: 150px;">
                                                                <option value="pending" <%=order.status==='pending'
                                                                    ? 'selected' : '' %>>Chờ xác nhận</option>
                                                                <option value="processing"
                                                                    <%=order.status==='processing' ? 'selected' : '' %>
                                                                    >Đang xử lý</option>
                                                                <option value="shipped" <%=order.status==='shipped'
                                                                    ? 'selected' : '' %>>Đang giao</option>
                                                                <option value="delivered" <%=order.status==='delivered'
                                                                    ? 'selected' : '' %>>Đã giao</option>
                                                                <option value="cancelled" <%=order.status==='cancelled'
                                                                    ? 'selected' : '' %>>Đã hủy</option>
                                                            </select>
                                                        </div>

                                                        <div class="col-md-3 py-2">
                                                            <button type="submit" class="btn btn-primary ms-2">Cập
                                                                nhật</button>
                                                        </div>
                                                        <div class="col-md-3 py-2">
                                                            <a href="/admin/order/<%= order._id %>/print"
                                                                class="btn btn-warning ms-2">
                                                                In hóa đơn
                                                            </a>
                                                        </div>

                                                </form>
                                            </div>

                                        </div>
                                    </div>

                                    <hr>

                                    <h6>Sản phẩm trong đơn hàng</h6>
                                    <table class="table table-bordered mt-3">
                                        <thead class="table-light">
                                            <tr>
                                                <th scope="col" style="width: 100px;">Ảnh</th>
                                                <th scope="col">Tên sản phẩm</th>
                                                <th scope="col">Giá</th>
                                                <th scope="col">Số lượng</th>
                                                <th scope="col">Thành tiền</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% order.items.forEach(item=> { %>
                                                <tr>
                                                    <td>
                                                        <% if (item.product && item.product.thumbnail &&
                                                            item.product.thumbnail.data) { %>
                                                            <img src="data:<%= item.product.thumbnail.contentType %>;base64,<%= item.product.thumbnail.data.toString('base64') %>"
                                                                alt="<%= item.product.name %>"
                                                                style="width: 80px; height: auto;">
                                                            <% } else if (item.variant && item.variant.images &&
                                                                item.variant.images.length> 0) { %>
                                                                <!-- Trường hợp này cần xem lại vì không có buffer -->
                                                                <!-- Có thể cần chỉnh sửa để lấy ảnh từ variant nếu cần thiết -->


                                                                <img src="/uploads/products/<%= item.variant.images[0] %>"
                                                                    alt="<%= item.product.name %>"
                                                                    style="width: 80px; height: auto;">
                                                                <% } else if (item.product && item.product.thumbnail) {
                                                                    %>
                                                                    <img src="/uploads/products/<%= item.product.thumbnail %>"
                                                                        alt="<%= item.product.name %>"
                                                                        style="width: 80px; height: auto;">
                                                                    <% } else { %>
                                                                        <img src="/client/img/default-product.png"
                                                                            alt="Default Image"
                                                                            style="width: 80px; height: auto;">
                                                                        <% } %>
                                                    </td>
                                                    <td>
                                                        <% if (item.product) { %>
                                                            <%= item.product.name %>
                                                                <% if (item.variant) { %>
                                                                    <br>
                                                                    <small class="text-muted">
                                                                        <% if (item.variant.ram) { %> RAM: <%=
                                                                                item.variant.ram %>
                                                                                <% } %>
                                                                                    <% if (item.variant.storage) { %> -
                                                                                        <%= item.variant.storage %>
                                                                                            <% } %>
                                                                                                <% if
                                                                                                    (item.variant.color)
                                                                                                    { %> - Màu: <%=
                                                                                                        item.variant.color
                                                                                                        %>
                                                                                                        <% } %>
                                                                    </small>
                                                                    <% } %>
                                                                        <% } else { %>
                                                                            Sản phẩm không tồn tại (<%= item.name %>)
                                                                                <% } %>
                                                    </td>
                                                    <td>
                                                        <%= new Intl.NumberFormat('vi-VN', { style: 'currency' ,
                                                            currency: 'VND' }).format(item.price) %>
                                                    </td>
                                                    <td>
                                                        <%= item.quantity %>
                                                    </td>
                                                    <td>
                                                        <%= new Intl.NumberFormat('vi-VN', { style: 'currency' ,
                                                            currency: 'VND' }).format(item.price * item.quantity) %>
                                                    </td>
                                                </tr>
                                                <% }) %>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>

                </div>
                </main>
                <%- include('../layout/footer'); -%>
        </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
            crossorigin="anonymous"></script>
        <script src="/admin/js/scripts.js"></script>



</body>

</html>